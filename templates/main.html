<!DOCTYPE html>
<html>
<title>{% block title %}{% endblock %}FYP填歌網</title>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='mdb/css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="{{ url_for('static', filename='mdb/css/mdb.min.css') }}" rel="stylesheet">
    <!-- Your custom styles (optional) -->
    <link href="{{ url_for('static', filename='mdb/css/style.css') }}" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" 
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" 
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" 
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='playercss.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='playerjs.js') }}"></script>
    <script src="{{ url_for('static', filename='loading.js') }}"></script>
    <link href="{{ url_for('static', filename='loading.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='popupmodal/js/popupmodal.js') }}"></script>
    <link href="{{ url_for('static', filename='popupmodal/css/popupmodal.css') }}" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container">
            <div class="row-eq-height">
                <div class="col-xs-2 top-left-icon">
                <img class ="center" src="https://img.icons8.com/ios/100/000000/musical-notes-filled.png" width="50" height="50" class="d-inline-block align-top" alt="">
                </div>
                <div class="col-xs-10">
                    <div class="nav-title" href="#">
                        多謝支持廣東歌
                    </div>
                </div>
            </div>
        </div>
    </nav> 

    <div class="container">
    <div class="card bg-light">
        <div class="card-header"> 1. 聽下呢首歌某一Part</div>

    <div class="card-body">

      <div class="player-wrap">
        <div class="player paused">
          <div class="progress-bar">
            <div class="runner"></div>
          </div>
          <div class="album-art">
            <div class="cover"></div>
          </div>

          <div class="description">
            <div class="title songNames_zh">{{songNames_zh}} </div>
            <div class="sub-title singers_zh">{{singers_zh}} </div>
          </div>
            
          <div class="play-button">
                <div class="lp-background"></div>
                <i class="mdi mdi-play"></i>
                <i class="mdi mdi-pause"></i>
          </div>
          
        </div>
      </div>

</div>
    </div>
</div>

<div class="container">
    <div class= "input-lyrics-fluid">
    <div class="card bg-light">
            <div class="card-header">2. (如有需要)可調教首歌頭尾開始時間</div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <p class="timer-text">開頭: <span class="startTime"></span></p>
                </div>
                <div class="col">
                    <p class="timer-text">結尾: <span class="endTime"></span></p>
                </div>
                <div class="col">
                    <p class="timer-text">段落長: <span class="timeDuration">秒</span></p>
                </div>
            </div>
            <hr class="timer-hr">
            <div id="slider-range"></div>
        </div>
    </div>
    </div>
</div>

<div class="container">
    <div class= "input-lyrics-fluid">
        <div class="card bg-light">
            <div class="card-header">3. 寫低啱啱果段歌詞</div>
        <div class="card-body">
        <div class="col-xs-12">
            <input class = 'lyrics-input'list="lyricsList" name="lyrics" autocomplete="off" type='text'>
            <label alt='呢度填歌詞' placeholder='多謝你為廣東歌出一份力!'></label>
            <datalist class ="datalist" id="lyricsList">
                {% for eachLine in lyrics %}
                <option class='options' value={{eachLine}}>
                {% endfor %}
            </datalist>
        </div>
        </div>
    </div>  
</div> 
</div> 




        <div class="container">
            <div class= "input-lyrics-fluid">
                <div class="card bg-light">
                    <div class="card-header">4. 如果無歌詞，麻煩剔下呢格</div>
                <div class="card-body input-Lyrics-area">
                    <div class= "input-Lyrics center">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input hasLyrics" id="customCheck1" name="hasLyrics" value="true">
                            <label class="custom-control-label" for="customCheck1">段野無歌詞/唔喺廣東話嚟啵</label>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
                <div class= "input-lyrics-fluid">
                    <div class="card bg-light">
                        <div class="card-header">5. 搞掂</div>
                    <div class="card-body">
                        無問題既，禁粒Button 就可以繼續下一段錄音，多謝大家幫手！！
                    </div>
                    </div>
                </div>
            </div>

        <div class= "submit-button-outer submit-btn">
            <button class ="submit-button btn btn-primary btn-lg center" >下一首</button>  
        </div>


    <footer class="page-footer font-small blue">
        <div class="footer-copyright text-center py-3">
            Declaration: Data collected shall be used purely for academic purpose only. 
        </div>
    </footer>
        

    <audio class='audioClip' id='player'
        src= {{audioSource}}>
            Your browser does not support the
            <code>audio</code> element.
    </audio>



<script>
$(function(){

//decleare variable
    var index = '{{index}}'
    var startTime = '{{startTime}}'
    var endTime = '{{endTime}}'
    var duration = '{{duration}}'
    var index = '{{index}}'
    var singers ='{{singers}}'
    var songNames = "{{songNames}}"
    var lyricsArray =[]
    var player = document.getElementById('player');  
    var startInterval =  startTime > 3 ? 3:0 
    var durationInterval = endTime - startTime
    var endInterval =  (duration -  endTime > 3 ? 3 : 0 )
    var playInterval = endInterval - startInterval
    var tmpCurrentTime = startInterval
    var audioPlayDuration= (durationInterval - startInterval -endInterval)
    var audioState = 'pause'

    var $player = $('.player');
    var ua = navigator.userAgent.toLowerCase();
    var isAndroid = ua.indexOf("android") > -1;
    var isWindows = ua.indexOf("windows") > -1;
    
    console.log("startTime: "+ startTime)
    console.log("endTime: "+ endTime)
    console.log("duration: " + duration)
    // console.log("startInterval: " + startInterval)
    console.log("endInterval: " + endInterval)
    console.log("durationInterval: " + durationInterval)
    console.log("playInterval: " + playInterval)
    console.log("tmpCurrentTime: " + tmpCurrentTime)
    console.log("audioPlayDuration: "+ audioPlayDuration)

    $( "#slider-range" ).slider({
        range: true,
        min: 0-startInterval,
        max: 3+audioPlayDuration,
        step: 0.1,
        values: [ 0, audioPlayDuration],
        animate: "fast",
        slide: function( event, ui ) {

            var head =  (ui.values[0] * -1);
            var totalLength = ui.values[1] + head
            audioPlayDuration = totalLength
            tmpCurrentTime = startInterval-head

            $('.startTime').html(sigFig(ui.values[0]))
            $('.endTime').html(sigFig(ui.values[1]))
            $(".timeDuration").html(sigFig(totalLength));
            // $('.audioClip').prop("currentTime",tmpCurrentTime);
            $('.audioClip').prop("currentTime",tmpCurrentTime)
        }
    });


// initialize correct interval of the audio
    $('.audioClip').prop("currentTime",tmpCurrentTime);
    $('.startTime').html("0.00")
    $('.endTime').html(sigFig(audioPlayDuration))
    $(".timeDuration").html(sigFig(audioPlayDuration))
    $(".hasLyrics").prop("checked", false);

//IOS: use jq plugin for auto-complete
    if(!(isAndroid || isWindows)) {
        $("option").each(function(){
            lyricsArray.push($(this).val())
        });

        $( ".lyrics-input" ).autocomplete({
            source: lyricsArray
        });
        //rename datalist to hide it in IOS
        $(".datalist").prop("id","newID")
    }


    $(".endRange").on("input", function(e) {
      var tmp = durationInterval - tmpCurrentTime - endInterval
      audioPlayDuration = tmp + parseFloat(this.value) > 0 ? tmp + parseFloat(this.value) : tmp
      $(".endTime").html(this.value)
    });

    $(".startRange").on("input",function(e) {
      tmpCurrentTime =parseFloat(startInterval)  + parseFloat(this.value)
      audioPlayDuration= durationInterval - tmpCurrentTime -endInterval
      $('.audioClip').prop("currentTime",tmpCurrentTime);
      $(".startTime").html(this.value)

      var currentTime = player.currentTime;
      var duration = player.duration;
      $('.start_marker').css({'width':'1%'});
      $('.start_marker').css({'left':(currentTime)/duration*100+'%'});
    });

// handle clicking box
    $(".input-Lyrics-area").click(function() {
        if ($('.hasLyrics').is(':checked')){
            $(".hasLyrics").prop("checked", false);
            $(".lyrics-input").prop('disabled', false);
            $(".startRange").prop('disabled', false);
            $(".endRange").prop('disabled', false);
        }else{
            $(".hasLyrics").prop("checked", true );
            $(".lyrics-input").prop('disabled', true);
            $(".endRange").prop('disabled', true);
            $(".startRange").prop('disabled', true);
        }
    });

// submit button click function
    $(".submit-button").click(function(){
        popup.confirm( { 
            content: '<strong>呢段歌詞如下:</strong><br><br>' + $('.lyrics-input').val(),
            keyboard : false,
            btn_align : 'right',
            effect : 'none',
            default_btns : {
                ok : '提交',
                cancel:'諗諗'
            }
        },
        function(param){
            if(param.proceed){
                submitData()
            }
        } 
         );
    });


$('.play-button').on('click', function() {
    if(audioState === 'pause'){
        // change the state and play the audio
        $player.removeClass('paused').toggleClass('playing');
        audioState = 'play'
        $('.audioClip').trigger('play');
        //stop after playing specific interval
        setTimeout(function(){
            if(audioState === 'play'){
                $('.audioClip').trigger('pause');
                $('.audioClip').prop("currentTime",tmpCurrentTime)
                $player.removeClass('playing').toggleClass('paused');
                audioState = 'pause'
            }
        }, audioPlayDuration*1000);
    }else{
        // change the state and reset the audio
        audioState = 'pause'
        counter += 1
        $('.audioClip').trigger('pause');
        $('.audioClip').prop("currentTime",tmpCurrentTime)
        // var currentTime = player.currentTime;
        // audioPlayDuration = audioPlayDuration - (tmpCurrentTime-currentTime)
        $player.removeClass('playing').toggleClass('paused');
    }
});

    //re-initialize the stuufs once a new song incoming
    function init(){
        startInterval =  startTime > 3 ? 3:0 
        durationInterval = endTime - startTime
        endInterval =  (duration -  endTime > 3 ? 3 : 0 )
        playInterval = endInterval - startInterval
        tmpCurrentTime = startInterval
        audioPlayDuration= durationInterval - startInterval -endInterval
        audioState = 'pause'

        // initialize correct interval of the audio
        $('.audioClip').prop("currentTime",tmpCurrentTime);
        $(".startRange").val(0);
        $(".endRange").val(0);
        $('.startTime').html("0")
        $('.endTime').html("0")
        $(".hasLyrics").prop("checked", false);
        $(".lyrics-input").prop('disabled', false);
        $(".startRange").prop('disabled', false);
        $(".endRange").prop('disabled', false);

        //change the lyrics if IOS
        if(!isAndroid || isWindows) {
            var lyricsArray =[]
            $("option").each(function(){
                lyricsArray.push($(this).val())
            });
            // console.log(lyricsArray)
            $( ".lyrics-input" ).autocomplete({
                source: lyricsArray
            });
        }
    }

    // submit data function
    function submitData() {
        var sendStartTime = parseFloat(startTime) + parseFloat($('.startTime').text()) + parseFloat(startInterval)
        var sendEndTime = sendStartTime +  parseFloat($(".timeDuration").text())

        $('body').loading({message: 'Send緊上Server...'});
                    var postJSON = {
            singer:singers,
            songName:songNames,
            start:sendStartTime,
            end: sendEndTime,
            lyrics:$('.lyrics-input').val(),
            isNotLyrics:$('.hasLyrics').is(':checked'),
            index: index,
            submitDate: Date.now()
        }
        $.ajax({
            url: "/submit_data",
            type: "POST",
            data: postJSON,
            success: function(res) {

                res = JSON.parse(res)
                songNames = res.songNames
                singers = res.singers
                startTime = res.startTime
                endTime = res.endTime
                index = res.index
                duration = res.duration

                $('.songNames_zh').html(res.songNames_zh)
                $('.singers_zh').html(res.singers_zh)
                $(".audioClip").attr("src", res.audioSource)
                $('.lyrics-input').val('')
                x = res.lyrics.map(function(val,index) {
                    return "<option class='options' value=" + val + ">"
                });
                $(".datalist").html(x)
                
                init();
            
                $('body').loading({
                    theme: 'dark',
                    message: '搞掂!多謝你呀!有下一首啦!',
                    stoppable: true
                });

                setTimeout(function(){
                    $('body').loading('stop');
                    $(window).scrollTop(0);
                }, 1500);
            },
            error: function(xhr) {
                //Do Something to handle error
            }
        });
    }; 
    
    function sigFig(x) {
        return Number.parseFloat(x).toFixed(2);
    }


});
</script>
</body>